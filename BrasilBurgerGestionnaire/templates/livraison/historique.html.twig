{% extends 'base.html.twig' %}

{% block title %}Historique des livraisons
{% endblock %}
{% block page_title %}Historique des livraisons
{% endblock %}

{% block body %}
	<!-- Breadcrumb -->
	<nav aria-label="breadcrumb" class="mb-4">
		<ol class="breadcrumb">
			<li class="breadcrumb-item">
				<a href="{{ path('app_livraison_index') }}">Livraisons</a>
			</li>
			<li class="breadcrumb-item active">Historique</li>
		</ol>
	</nav>

	<!-- Liste des commandes -->
	<div class="card">
		<div class="card-header bg-white">
			<h5 class="mb-0">
				<i class="bi bi-clock-history"></i>
				Historique des livraisons ({{ commandes|length }})
			</h5>
		</div>
		<div class="card-body p-0">
			{% if commandes is empty %}
				<div class="text-center py-5 text-muted">
					<i class="bi bi-inbox" style="font-size: 3rem;"></i>
					<p class="mt-3">Aucune livraison dans l'historique</p>
				</div>
			{% else %}
				<div class="table-responsive">
					<table class="table table-hover mb-0">
						<thead class="table-light">
							<tr>
								<th>N° Commande</th>
								<th>Date</th>
								<th>Client</th>
								<th>Adresse</th>
								<th>Zone</th>
								<th>Livreur</th>
								<th>Montant</th>
								<th>État</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for commande in commandes %}
								<tr>
									<td>
										<strong>{{ commande.numeroCommande }}</strong>
									</td>
									<td>
										<small>{{ commande.dateCommande|date('d/m/Y H:i') }}</small>
									</td>
									<td>
										{{ commande.client.prenom }}
										{{ commande.client.nom }}<br>
										<small class="text-muted">{{ commande.client.tel }}</small>
									</td>
									<td>
										<small>{{ commande.adresseLivraison|slice(0, 40) }}
											{% if commande.adresseLivraison|length > 40 %}...
											{% endif %}
										</small>
									</td>
									<td>
										{% if commande.zone %}
											<span class="badge bg-secondary">{{ commande.zone.nom }}</span>
										{% else %}
											<span class="text-muted">-</span>
										{% endif %}
									</td>
									<td>
										{% if commande.livreur %}
											<i class="bi bi-person-badge text-primary"></i>
											{{ commande.livreur.prenom }}
											{{ commande.livreur.nom }}
										{% else %}
											<span class="text-muted">Non affecté</span>
										{% endif %}
									</td>
									<td>
										<strong class="text-primary">{{ commande.montantTotal|number_format(0, ',', ' ') }}
											FCFA</strong>
									</td>
									<td>
										{% set badgeClass = {
                                        'EN_LIVRAISON': 'info',
                                        'LIVREE': 'success'
                                    } %}
										<span class="badge bg-{{ badgeClass[commande.etat] ?? 'secondary' }}">
											{{ commande.etat|replace({'_': ' '}) }}
										</span>
									</td>
									<td class="text-end">
										<a href="{{ path('app_commande_show', {id: commande.id}) }}" class="btn btn-sm btn-outline-primary me-1">
											<i class="bi bi-eye"></i>
										</a>

										{% if commande.etat == 'EN_LIVRAISON' %}
											<form method="post" action="{{ path('app_livraison_retirer', {id: commande.id}) }}" class="d-inline" onsubmit="return confirm('Retirer le livreur de cette commande ?');">
												<input type="hidden" name="_token" value="{{ csrf_token('retirer_livreur_' ~ commande.id) }}">
												<button type="submit" class="btn btn-sm btn-outline-danger" title="Retirer le livreur">
													<i class="bi bi-person-x"></i>
												</button>
											</form>
										{% endif %}
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			{% endif %}
		</div>
	</div>

	<!-- Retour -->
	<div class="mt-3">
		<a href="{{ path('app_livraison_index') }}" class="btn btn-outline-secondary">
			<i class="bi bi-arrow-left"></i>
			Retour aux livraisons en attente
		</a>
	</div>
{% endblock %}
